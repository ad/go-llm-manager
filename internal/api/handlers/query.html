<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <title>SSE Polling Query Demo</title>
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <style>
        body { font-family: Arial, sans-serif; background: #f7f7f7; margin: 0; padding: 0; }
        .container { max-width: 600px; margin: 40px auto; background: #fff; border-radius: 8px; box-shadow: 0 2px 8px #0001; padding: 32px 24px; }
        h2, h3 { margin-top: 0; }
        .form-row { display: flex; gap: 10px; margin-bottom: 16px; }
        input, select { flex: 1; padding: 8px; border-radius: 4px; border: 1px solid #ccc; }
        button { padding: 8px 18px; border: none; border-radius: 4px; margin-right: 8px; cursor: pointer; }
        .btn-success { background: #27ae60; color: #fff; }
        .btn-danger { background: #e74c3c; color: #fff; }
        .btn-warning { background: #f39c12; color: #fff; }
        .result { margin-top: 18px; padding: 12px; border-radius: 4px; background: #f8f9fa; min-height: 32px; font-family: monospace; }
        .status { font-weight: bold; }
        .log { font-size: 0.95em; color: #888; margin-top: 18px; background: #f4f4f4; border-radius: 4px; padding: 10px; max-height: 180px; overflow-y: auto; }
    </style>
</head>
<body>
    <div class="container">
        <h2>üöÄ SSE Polling Query Demo</h2>
        <p>–î–µ–º–æ–Ω—Å—Ç—Ä–∞—Ü–∏—è —Ä–∞–±–æ—Ç—ã SSE endpoint <code>/api/result-polling</code> —Å —á–∏—Å—Ç—ã–º –∫–ª–∏–µ–Ω—Ç—Å–∫–∏–º –∫–æ–¥–æ–º.</p>
        <div class="form-row">
            <input type="text" id="prompt" placeholder="–í–≤–µ–¥–∏—Ç–µ –∑–∞–ø—Ä–æ—Å..." value="–ù–∞–ø–∏—à–∏ –∫–æ—Ä–æ—Ç–∫–æ–µ —Å—Ç–∏—Ö–æ—Ç–≤–æ—Ä–µ–Ω–∏–µ –ø—Ä–æ –∫–æ—Ç–∞">
            <select id="model">
                <option value="gemma3:1b">Gemma3 1B</option>
                <option value="llama3.2:1b">llama3.2:1b</option>
                <option value="llama3.2:3b">llama3.2:3b</option>
                <option value="qwen2.5:1.5b">qwen2.5:1.5b</option>
            </select>
        </div>
        <div style="margin: 15px 0;">
            <button id="startBtn" class="btn-success">üöÄ –ó–∞–ø—É—Å—Ç–∏—Ç—å SSE</button>
            <button id="stopBtn" class="btn-danger" disabled>‚èπÔ∏è –û—Å—Ç–∞–Ω–æ–≤–∏—Ç—å SSE</button>
            <button id="clearBtn" class="btn-warning">üóëÔ∏è –û—á–∏—Å—Ç–∏—Ç—å</button>
        </div>
        <div id="status" class="result"></div>
        <div id="result" class="result"></div>
        <div id="log" class="log"></div>
    </div>
    <script>
        let sse = null;
        let taskToken = null;
        let taskFinalized = false;

        function log(msg) {
            const logDiv = document.getElementById('log');
            logDiv.innerHTML += `[${new Date().toLocaleTimeString()}] ${msg}<br>`;
            logDiv.scrollTop = logDiv.scrollHeight;
        }

        function setStatus(msg) {
            document.getElementById('status').textContent = msg;
        }
        function setResult(msg) {
            document.getElementById('result').textContent = msg;
        }
        function clearAll() {
            setStatus('');
            setResult('');
            document.getElementById('log').innerHTML = '';
            taskFinalized = false;
            if (sse) { sse.close(); sse = null; }
            document.getElementById('stopBtn').disabled = true;
            document.getElementById('startBtn').disabled = false;
        }

        document.getElementById('clearBtn').onclick = clearAll;

        document.getElementById('startBtn').onclick = async function() {
            clearAll();
            setStatus('‚è≥ –°–æ–∑–¥–∞–Ω–∏–µ –∑–∞–¥–∞—á–∏...');
            document.getElementById('startBtn').disabled = true;
            const prompt = document.getElementById('prompt').value;
            const model = document.getElementById('model').value;
            try {
                // 1. –ü–æ–ª—É—á–∞–µ–º JWT —á–µ—Ä–µ–∑ /api/internal/generate-token
                const tokenResp = await fetch('/api/internal/generate-token', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'Authorization': 'Bearer dev-internal-key'
                    },
                    body: JSON.stringify({
                        user_id: 'sse_demo_' + Date.now(),
                        product_data: '–í–∞—Å—å–∫–∞',
                        ollama_params: { model, prompt }
                    })
                });
                if (!tokenResp.ok) throw new Error('–û—à–∏–±–∫–∞ –≥–µ–Ω–µ—Ä–∞—Ü–∏–∏ —Ç–æ–∫–µ–Ω–∞');
                const tokenData = await tokenResp.json();
                if (!tokenData.success) throw new Error(tokenData.error || '–û—à–∏–±–∫–∞ —Ç–æ–∫–µ–Ω–∞');
                taskToken = tokenData.token;
                log('‚úÖ JWT –ø–æ–ª—É—á–µ–Ω');
                // 2. –°–æ–∑–¥–∞–µ–º –∑–∞–¥–∞—á—É
                const createResp = await fetch('/api/create', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json', 'Authorization': 'Bearer ' + taskToken }
                });
                if (!createResp.ok) throw new Error('–û—à–∏–±–∫–∞ —Å–æ–∑–¥–∞–Ω–∏—è –∑–∞–¥–∞—á–∏');
                const createData = await createResp.json();
                if (!createData.success) throw new Error(createData.error || '–û—à–∏–±–∫–∞ —Å–æ–∑–¥–∞–Ω–∏—è –∑–∞–¥–∞—á–∏');
                log('‚úÖ –ó–∞–¥–∞—á–∞ —Å–æ–∑–¥–∞–Ω–∞: ' + createData.taskId);
                setStatus('üîÑ –û–∂–∏–¥–∞–Ω–∏–µ SSE...');
                // 3. –ó–∞–ø—É—Å–∫–∞–µ–º SSE
                startSSE(createData.token);
                document.getElementById('stopBtn').disabled = false;
            } catch (e) {
                setStatus('‚ùå ' + e.message);
                log('‚ùå ' + e.message);
                document.getElementById('startBtn').disabled = false;
            }
        };

        document.getElementById('stopBtn').onclick = function() {
            if (sse) sse.close();
            setStatus('‚èπÔ∏è SSE –æ—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω');
            log('‚èπÔ∏è SSE —Å–æ–µ–¥–∏–Ω–µ–Ω–∏–µ –∑–∞–∫—Ä—ã—Ç–æ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–º');
            document.getElementById('stopBtn').disabled = true;
            document.getElementById('startBtn').disabled = false;
        };

        function startSSE(token) {
            if (sse) sse.close();
            sse = new EventSource('/api/result-polling?token=' + encodeURIComponent(token));
            setStatus('üì° –û–∂–∏–¥–∞–Ω–∏–µ —Å–æ–±—ã—Ç–∏–π SSE...');
            log('üì° –û—Ç–∫—Ä—ã—Ç–æ SSE —Å–æ–µ–¥–∏–Ω–µ–Ω–∏–µ');
            sse.onopen = () => log('‚úÖ SSE —Å–æ–µ–¥–∏–Ω–µ–Ω–∏–µ —É—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω–æ');
            sse.onmessage = (event) => {
                log('‚û°Ô∏è –ü–æ–ª—É—á–µ–Ω–æ —Å–æ–±—ã—Ç–∏–µ: ' + event.data);
                try {
                    const data = JSON.parse(event.data);
                    if (data.type === 'heartbeat') {
                        setStatus('üíì Heartbeat: ' + (data.data.message || '')); 
                    } else if (data.type === 'task_status') {
                        setStatus('üìä –°—Ç–∞—Ç—É—Å: ' + data.data.status);
                        setResult('‚è≥ ' + JSON.stringify(data.data, null, 2));
                    } else if (data.type === 'task_completed') {
                        setStatus('‚úÖ –ó–∞–¥–∞—á–∞ –∑–∞–≤–µ—Ä—à–µ–Ω–∞');
                        setResult('üéâ ' + JSON.stringify(data.data, null, 2));
                        taskFinalized = true;
                        sse.close();
                        document.getElementById('stopBtn').disabled = true;
                        document.getElementById('startBtn').disabled = false;
                    } else if (data.type === 'task_failed') {
                        setStatus('‚ùå –ó–∞–¥–∞—á–∞ –ø—Ä–æ–≤–∞–ª–µ–Ω–∞');
                        setResult('‚ùå ' + JSON.stringify(data.data, null, 2));
                        taskFinalized = true;
                        sse.close();
                        document.getElementById('stopBtn').disabled = true;
                        document.getElementById('startBtn').disabled = false;
                    } else if (data.type === 'error') {
                        setStatus('‚ùå SSE –æ—à–∏–±–∫–∞: ' + (data.data.error || ''));
                        log('‚ùå SSE –æ—à–∏–±–∫–∞: ' + (data.data.error || ''));
                    } else {
                        setStatus('üìù –ù–µ–∏–∑–≤–µ—Å—Ç–Ω–æ–µ —Å–æ–±—ã—Ç–∏–µ: ' + data.type);
                        setResult(JSON.stringify(data, null, 2));
                    }
                } catch (err) {
                    setStatus('‚ùå –û—à–∏–±–∫–∞ –ø–∞—Ä—Å–∏–Ω–≥–∞ SSE: ' + err.message);
                    log('‚ùå –û—à–∏–±–∫–∞ –ø–∞—Ä—Å–∏–Ω–≥–∞: ' + err.message);
                }
            };
            sse.onerror = (event) => {
                log('‚ùå SSE –æ—à–∏–±–∫–∞ —Å–æ–µ–¥–∏–Ω–µ–Ω–∏—è');
                console.error('SSE error:', event);
                if (!taskFinalized) setStatus('‚ùå SSE –æ—à–∏–±–∫–∞ —Å–æ–µ–¥–∏–Ω–µ–Ω–∏—è');
            };
        }
    </script>
</body>
</html>
