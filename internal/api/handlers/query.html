<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <title>SSE Polling Query Demo</title>
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <style>
        body { font-family: Arial, sans-serif; background: #f7f7f7; margin: 0; padding: 0; }
        .container { max-width: 600px; margin: 40px auto; background: #fff; border-radius: 8px; box-shadow: 0 2px 8px #0001; padding: 32px 24px; }
        h2, h3 { margin-top: 0; }
        .form-row { display: flex; gap: 10px; margin-bottom: 16px; }
        input, select { flex: 1; padding: 8px; border-radius: 4px; border: 1px solid #ccc; }
        button { padding: 8px 18px; border: none; border-radius: 4px; margin-right: 8px; cursor: pointer; }
        .btn-success { background: #27ae60; color: #fff; }
        .btn-danger { background: #e74c3c; color: #fff; }
        .btn-warning { background: #f39c12; color: #fff; }
        .btn-info { background: #3498db; color: #fff; }
        .result { margin-top: 18px; padding: 12px; border-radius: 4px; background: #f8f9fa; min-height: 32px; font-family: monospace; }
        .status { font-weight: bold; }
        .log { font-size: 0.95em; color: #888; margin-top: 18px; background: #f4f4f4; border-radius: 4px; padding: 10px; max-height: 180px; overflow-y: auto; }
        
        /* Voting buttons styles */
        .voting-container { margin-top: 15px; text-align: center; }
        .vote-button { 
            padding: 8px 16px; 
            margin: 0 5px; 
            border: 2px solid #ddd; 
            border-radius: 4px; 
            background: #fff; 
            cursor: pointer; 
            font-size: 16px;
            transition: all 0.2s ease;
        }
        .vote-button:hover { 
            background: #f0f0f0; 
            transform: scale(1.05);
        }
        .vote-button.vote-active { 
            background: #007bff; 
            color: white; 
            border-color: #0056b3;
        }
        .vote-button.upvote.vote-active { 
            background: #28a745; 
            border-color: #1e7e34;
        }
        .vote-button.downvote.vote-active { 
            background: #dc3545; 
            border-color: #c82333;
        }
    </style>
</head>
<body>
    <div class="container">
        <h2>üöÄ SSE Polling Query Demo</h2>
        <div class="form-row">
            <input type="text" id="apiKey" value="dev-internal-key" placeholder="API Key (dev-internal-key)">
        </div>
        <div class="form-row">
            <input type="text" id="userId" placeholder="User ID..." value="demo_user_123">
        </div>
        <div class="form-row">
            <input type="text" id="prompt" placeholder="–í–≤–µ–¥–∏—Ç–µ –∑–∞–ø—Ä–æ—Å..." value="–ù–∞–ø–∏—à–∏ –∫–æ—Ä–æ—Ç–∫–æ–µ —Å—Ç–∏—Ö–æ—Ç–≤–æ—Ä–µ–Ω–∏–µ –ø—Ä–æ –∫–æ—Ç–∞">
        </div>
        <div class="form-row">
            <select id="model">
                <option value="gemma3n:e2b-it-q4_K_M">Gemma3n 2B</option>
                <option value="gemma3:1b">Gemma3 1B</option>
                <option value="hf.co/RefalMachine/ruadapt_qwen2.5_3B_ext_u48_instruct_v4_gguf:latest">RuAdapt Qwen2.5 3B</option>
                <option value="hf.co/RefalMachine/RuadaptQwen3-4B-Instruct-GGUF:Q4_K_M">RuAdapt Qwen3 4B</option>
                <option value="llama3.2:3b">Llama 3.2 3B</option>
                <option value="llama3.1:8b">Llama 3.1 8B</option>
                <option value="smollm2:1.7b">SmolLM2 1.7B</option>
            </select>
        </div>
        <div style="margin: 15px 0;">
            <button id="startBtn" class="btn-success">üöÄ –ó–∞–ø—É—Å—Ç–∏—Ç—å</button>
            <button id="stopBtn" class="btn-danger" disabled>‚èπÔ∏è –û—Å—Ç–∞–Ω–æ–≤–∏—Ç—å</button>
            <button id="clearBtn" class="btn-warning">üóëÔ∏è –û—á–∏—Å—Ç–∏—Ç—å</button>
            <button onclick="loadUserData()" class="btn-info">üì• –ü–æ—Å–ª–µ–¥–Ω–∏–π –∑–∞–ø—Ä–æ—Å</button>
        </div>
        <div id="status" class="result"></div>
        <div id="result" class="result"></div>
        <div id="votingContainer" class="voting-container" style="display: none;">
            <h3>–û—Ü–µ–Ω–∏—Ç–µ –∫–∞—á–µ—Å—Ç–≤–æ –æ—Ç–≤–µ—Ç–∞:</h3>
            <button id="upvoteBtn" class="vote-button upvote" onclick="voteTask('upvote')">üëç –•–æ—Ä–æ—à–æ</button>
            <button id="downvoteBtn" class="vote-button downvote" onclick="voteTask('downvote')">üëé –ü–ª–æ—Ö–æ</button>
        </div>
        <div id="log" class="log"></div>
    </div>
    <script>
        let sse = null;
        let taskToken = null;
        let taskFinalized = false;
        let currentTaskId = null;
        let currentUserRating = null;

        function log(msg) {
            const logDiv = document.getElementById('log');
            logDiv.innerHTML += `[${new Date().toLocaleTimeString()}] ${msg}<br>`;
            logDiv.scrollTop = logDiv.scrollHeight;
        }

        function setStatus(msg) {
            document.getElementById('status').textContent = msg;
        }
        function setResult(msg) {
            document.getElementById('result').textContent = msg;
        }
        
        function clearAll() {
            setStatus('');
            setResult('');
            document.getElementById('log').innerHTML = '';
            taskFinalized = false;
            currentTaskId = null;
            currentUserRating = null;
            hideVotingButtons();
            if (sse) { sse.close(); sse = null; }
            document.getElementById('stopBtn').disabled = true;
            document.getElementById('startBtn').disabled = false;
        }

        function showVotingButtons() {
            document.getElementById('votingContainer').style.display = 'block';
            updateVotingButtons();
        }

        function hideVotingButtons() {
            document.getElementById('votingContainer').style.display = 'none';
        }

        function updateVotingButtons() {
            const upvoteBtn = document.getElementById('upvoteBtn');
            const downvoteBtn = document.getElementById('downvoteBtn');
            
            // Reset classes
            upvoteBtn.classList.remove('vote-active');
            downvoteBtn.classList.remove('vote-active');
            
            // Set active state based on current rating
            if (currentUserRating === 'upvote') {
                upvoteBtn.classList.add('vote-active');
            } else if (currentUserRating === 'downvote') {
                downvoteBtn.classList.add('vote-active');
            }
        }

        async function voteTask(voteType) {
            if (!currentTaskId || !taskToken) {
                log('‚ùå –ù–µ—Ç –∞–∫—Ç–∏–≤–Ω–æ–π –∑–∞–¥–∞—á–∏ –¥–ª—è –≥–æ–ª–æ—Å–æ–≤–∞–Ω–∏—è');
                return;
            }

            try {
                log(`üó≥Ô∏è –û—Ç–ø—Ä–∞–≤–∫–∞ –≥–æ–ª–æ—Å–∞: ${voteType}`);
                
                // Check for toggle behavior
                const actualVoteType = (currentUserRating === voteType) ? '' : voteType;
                
                const response = await fetch(`/api/tasks/${currentTaskId}/vote`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'Authorization': `Bearer ${taskToken}`
                    },
                    body: JSON.stringify({
                        vote_type: actualVoteType
                    })
                });

                if (!response.ok) {
                    const errorData = await response.text();
                    throw new Error(`HTTP ${response.status}: ${errorData}`);
                }

                const data = await response.json();
                currentUserRating = data.rating;
                updateVotingButtons();
                
                if (data.rating) {
                    log(`‚úÖ –ì–æ–ª–æ—Å –æ—Ç–ø—Ä–∞–≤–ª–µ–Ω: ${data.rating}`);
                } else {
                    log(`‚úÖ –ì–æ–ª–æ—Å —É–±—Ä–∞–Ω`);
                }
                
            } catch (error) {
                log(`‚ùå –û—à–∏–±–∫–∞ –≥–æ–ª–æ—Å–æ–≤–∞–Ω–∏—è: ${error.message}`);
            }
        }

        document.getElementById('clearBtn').onclick = clearAll;

        async function loadUserData() {
            const apiKey = document.getElementById('apiKey').value;
            const userId = document.getElementById('userId').value;
            
            if (!userId) {
                log('‚ö†Ô∏è –í–≤–µ–¥–∏—Ç–µ User ID –¥–ª—è –∑–∞–≥—Ä—É–∑–∫–∏ –¥–∞–Ω–Ω—ã—Ö');
                return;
            }
            
            try {
                log('üîë –ì–µ–Ω–µ—Ä–∞—Ü–∏—è JWT —Ç–æ–∫–µ–Ω–∞ –¥–ª—è –∑–∞–≥—Ä—É–∑–∫–∏ –¥–∞–Ω–Ω—ã—Ö...');
                
                // –ì–µ–Ω–µ—Ä–∏—Ä—É–µ–º JWT —Ç–æ–∫–µ–Ω —Å–ø–µ—Ü–∏–∞–ª—å–Ω–æ –¥–ª—è –ø–æ–ª—É—á–µ–Ω–∏—è –¥–∞–Ω–Ω—ã—Ö –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è
                const tokenResp = await fetch('/api/internal/generate-token', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'Authorization': 'Bearer ' + apiKey
                    },
                    body: JSON.stringify({
                        user_id: userId,
                        product_data: 'temp' // –ú–∏–Ω–∏–º–∞–ª—å–Ω—ã–µ –¥–∞–Ω–Ω—ã–µ –¥–ª—è –≥–µ–Ω–µ—Ä–∞—Ü–∏–∏ —Ç–æ–∫–µ–Ω–∞
                    })
                });
                
                if (!tokenResp.ok) throw new Error('–û—à–∏–±–∫–∞ –≥–µ–Ω–µ—Ä–∞—Ü–∏–∏ —Ç–æ–∫–µ–Ω–∞');
                const tokenData = await tokenResp.json();
                if (!tokenData.success) throw new Error(tokenData.error || '–û—à–∏–±–∫–∞ —Ç–æ–∫–µ–Ω–∞');
                
                const tempToken = tokenData.token;
                log('‚úÖ JWT —Ç–æ–∫–µ–Ω –¥–ª—è –∑–∞–≥—Ä—É–∑–∫–∏ –¥–∞–Ω–Ω—ã—Ö –ø–æ–ª—É—á–µ–Ω');
                log('üì• –ó–∞–≥—Ä—É–∑–∫–∞ –¥–∞–Ω–Ω—ã—Ö –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è...');
                
                const response = await fetch('/api/get?token=' + encodeURIComponent(tempToken));
                if (!response.ok) throw new Error('–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ –¥–∞–Ω–Ω—ã—Ö');
                
                const data = await response.json();
                if (!data.success) throw new Error(data.error || '–û—à–∏–±–∫–∞ –¥–∞–Ω–Ω—ã—Ö');
                
                log('‚úÖ –î–∞–Ω–Ω—ã–µ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è –∑–∞–≥—Ä—É–∂–µ–Ω—ã');
                
                // –ó–∞–ø–æ–ª–Ω—è–µ–º –ø–æ–ª—è —Ñ–æ—Ä–º—ã –¥–∞–Ω–Ω—ã–º–∏ –ø–æ—Å–ª–µ–¥–Ω–µ–π –∑–∞–¥–∞—á–∏
                if (data.last_task) {
                    const task = data.last_task;
                    log(`üìã –ü–æ—Å–ª–µ–¥–Ω—è—è –∑–∞–¥–∞—á–∞: ID ${task.id}, —Å—Ç–∞—Ç—É—Å: ${task.status}`);
                    
                    // –ó–∞–ø–æ–ª–Ω—è–µ–º –ø—Ä–æ–º–ø—Ç –∏ –º–æ–¥–µ–ª—å, –µ—Å–ª–∏ –æ–Ω–∏ –µ—Å—Ç—å
                    if (task.ollama_params) {
                        if (task.ollama_params.prompt) {
                            document.getElementById('prompt').value = task.product_data;
                            log('üìù –ó–∞–ø–æ–ª–Ω–µ–Ω –ø—Ä–æ–º–ø—Ç –∏–∑ –ø–æ—Å–ª–µ–¥–Ω–µ–π –∑–∞–¥–∞—á–∏');
                        }
                        if (task.ollama_params.model) {
                            const modelSelect = document.getElementById('model');
                            if ([...modelSelect.options].some(option => option.value === task.ollama_params.model)) {
                                modelSelect.value = task.ollama_params.model;
                                log('ü§ñ –ó–∞–ø–æ–ª–Ω–µ–Ω–∞ –º–æ–¥–µ–ª—å –∏–∑ –ø–æ—Å–ª–µ–¥–Ω–µ–π –∑–∞–¥–∞—á–∏');
                            }
                        }
                    }
                    
                    // Show voting buttons if task is completed
                    if (task.status === 'completed') {
                        currentTaskId = task.id;
                        currentUserRating = task.rating || null;
                        taskToken = task.token || tempToken; // Use task token if available, otherwise temp token
                        showVotingButtons();
                        log('üó≥Ô∏è –ö–Ω–æ–ø–∫–∏ –≥–æ–ª–æ—Å–æ–≤–∞–Ω–∏—è –¥–æ—Å—Ç—É–ø–Ω—ã –¥–ª—è –∑–∞–≤–µ—Ä—à–µ–Ω–Ω–æ–π –∑–∞–¥–∞—á–∏');
                    }
                }
                
                // –ü–æ–∫–∞–∑—ã–≤–∞–µ–º –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—é –æ rate limits
                if (data.rate_limit) {
                    const rl = data.rate_limit;
                    log(`üìä Rate limits: –ó–∞–ø—Ä–æ—Å—ã: ${rl.request_count}/${rl.request_limit}`);
                }
                
            } catch (error) {
                log('‚ùå –û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ –¥–∞–Ω–Ω—ã—Ö –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è: ' + error.message);
            }
        }

        document.getElementById('clearBtn').onclick = clearAll;

        document.getElementById('startBtn').onclick = async function() {
            clearAll();
            setStatus('‚è≥ –°–æ–∑–¥–∞–Ω–∏–µ –∑–∞–¥–∞—á–∏...');
            document.getElementById('startBtn').disabled = true;
            const prompt = document.getElementById('prompt').value;
            const model = document.getElementById('model').value;
            try {
                // 1. –ü–æ–ª—É—á–∞–µ–º JWT —á–µ—Ä–µ–∑ /api/internal/generate-token
                const tokenResp = await fetch('/api/internal/generate-token', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'Authorization': 'Bearer ' + document.getElementById('apiKey').value
                    },
                    body: JSON.stringify({
                        user_id: 'sse_demo_' + Date.now(),
                        product_data: '–í–∞—Å—å–∫–∞',
                        ollama_params: { model, prompt }
                    })
                });
                if (!tokenResp.ok) throw new Error('–û—à–∏–±–∫–∞ –≥–µ–Ω–µ—Ä–∞—Ü–∏–∏ —Ç–æ–∫–µ–Ω–∞');
                const tokenData = await tokenResp.json();
                if (!tokenData.success) throw new Error(tokenData.error || '–û—à–∏–±–∫–∞ —Ç–æ–∫–µ–Ω–∞');
                taskToken = tokenData.token;
                log('‚úÖ JWT –ø–æ–ª—É—á–µ–Ω');
                // 2. –°–æ–∑–¥–∞–µ–º –∑–∞–¥–∞—á—É
                const createResp = await fetch('/api/create', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json', 'Authorization': 'Bearer ' + taskToken }
                });
                if (!createResp.ok) throw new Error('–û—à–∏–±–∫–∞ —Å–æ–∑–¥–∞–Ω–∏—è –∑–∞–¥–∞—á–∏');
                const createData = await createResp.json();
                if (!createData.success) throw new Error(createData.error || '–û—à–∏–±–∫–∞ —Å–æ–∑–¥–∞–Ω–∏—è –∑–∞–¥–∞—á–∏');
                currentTaskId = createData.taskId;
                log('‚úÖ –ó–∞–¥–∞—á–∞ —Å–æ–∑–¥–∞–Ω–∞: ' + createData.taskId);
                setStatus('üîÑ –û–∂–∏–¥–∞–Ω–∏–µ SSE...');
                // 3. –ó–∞–ø—É—Å–∫–∞–µ–º SSE
                startSSE(createData.token);
                document.getElementById('stopBtn').disabled = false;
            } catch (e) {
                setStatus('‚ùå ' + e.message);
                log('‚ùå ' + e.message);
                document.getElementById('startBtn').disabled = false;
            }
        };

        document.getElementById('stopBtn').onclick = function() {
            if (sse) sse.close();
            setStatus('‚èπÔ∏è SSE –æ—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω');
            log('‚èπÔ∏è SSE —Å–æ–µ–¥–∏–Ω–µ–Ω–∏–µ –∑–∞–∫—Ä—ã—Ç–æ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–º');
            document.getElementById('stopBtn').disabled = true;
            document.getElementById('startBtn').disabled = false;
        };

        function startSSE(token) {
            if (sse) sse.close();
            sse = new EventSource('/api/result-polling?token=' + encodeURIComponent(token));
            setStatus('üì° –û–∂–∏–¥–∞–Ω–∏–µ —Å–æ–±—ã—Ç–∏–π SSE...');
            log('üì° –û—Ç–∫—Ä—ã—Ç–æ SSE —Å–æ–µ–¥–∏–Ω–µ–Ω–∏–µ');
            sse.onopen = () => log('‚úÖ SSE —Å–æ–µ–¥–∏–Ω–µ–Ω–∏–µ —É—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω–æ');
            sse.onmessage = (event) => {
                log('‚û°Ô∏è –ü–æ–ª—É—á–µ–Ω–æ —Å–æ–±—ã—Ç–∏–µ: ' + event.data);
                try {
                    const data = JSON.parse(event.data);
                    if (data.type === 'heartbeat') {
                        setStatus('üíì Heartbeat: ' + (data.data.message || '')); 
                    } else if (data.type === 'task_status') {
                        setStatus('üìä –°—Ç–∞—Ç—É—Å: ' + data.data.status);
                        setResult('‚è≥ ' + JSON.stringify(data.data, null, 2));
                    } else if (data.type === 'task_completed') {
                        setStatus('‚úÖ –ó–∞–¥–∞—á–∞ –∑–∞–≤–µ—Ä—à–µ–Ω–∞');
                        setResult('üéâ ' + JSON.stringify(data.data, null, 2));
                        
                        // Show voting buttons for completed task
                        currentUserRating = data.data.rating || null;
                        showVotingButtons();
                        
                        taskFinalized = true;
                        sse.close();
                        document.getElementById('stopBtn').disabled = true;
                        document.getElementById('startBtn').disabled = false;
                    } else if (data.type === 'task_failed') {
                        setStatus('‚ùå –ó–∞–¥–∞—á–∞ –ø—Ä–æ–≤–∞–ª–µ–Ω–∞');
                        setResult('‚ùå ' + JSON.stringify(data.data, null, 2));
                        taskFinalized = true;
                        sse.close();
                        document.getElementById('stopBtn').disabled = true;
                        document.getElementById('startBtn').disabled = false;
                    } else if (data.type === 'error') {
                        setStatus('‚ùå SSE –æ—à–∏–±–∫–∞: ' + (data.data.error || ''));
                        log('‚ùå SSE –æ—à–∏–±–∫–∞: ' + (data.data.error || ''));
                    } else {
                        setStatus('üìù –ù–µ–∏–∑–≤–µ—Å—Ç–Ω–æ–µ —Å–æ–±—ã—Ç–∏–µ: ' + data.type);
                        setResult(JSON.stringify(data, null, 2));
                    }
                } catch (err) {
                    setStatus('‚ùå –û—à–∏–±–∫–∞ –ø–∞—Ä—Å–∏–Ω–≥–∞ SSE: ' + err.message);
                    log('‚ùå –û—à–∏–±–∫–∞ –ø–∞—Ä—Å–∏–Ω–≥–∞: ' + err.message);
                }
            };
            sse.onerror = (event) => {
                log('‚ùå SSE –æ—à–∏–±–∫–∞ —Å–æ–µ–¥–∏–Ω–µ–Ω–∏—è');
                console.error('SSE error:', event);
                if (!taskFinalized) setStatus('‚ùå SSE –æ—à–∏–±–∫–∞ —Å–æ–µ–¥–∏–Ω–µ–Ω–∏—è');
            };
        }
    </script>
</body>
</html>
